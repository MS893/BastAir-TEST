<div class="card shadow-sm
">
  <div class="card-header bg-primary text-white">
    <h4 class="mb-0">Transaction</h4>
  </div>
  <div class="card-body">
    <%# On utilise form_with, comme dans le formulaire de création d'adhérent %>
    <%= form_with(model: @transaction, local: true) do |form| %>

      <%# Affichage des erreurs, inspiré du formulaire de création d'adhérent %>
      <% if @transaction.errors.any? %>
        <div class="alert alert-danger">
          <h5><%= pluralize(@transaction.errors.count, "erreur") %> a empêché cette transaction d'être sauvegardée :</h5>
          <ul>
            <% @transaction.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <h5 class="mb-3">Informations principales</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :date_transaction, "Date de la transaction" %>
          <%= form.date_field :date_transaction, class: "form-control" %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :montant %>
          <%= form.number_field :montant, class: "form-control", step: '0.01', placeholder: "0" %>
        </div>
      </div>
      <div class="mb-3">
        <%= form.text_area :description, class: "form-control", placeholder: "Description de la transaction", rows: 3 %>
      </div>

      <hr class="my-4">
      <h5 class="mb-3">Catégorisation</h5>
      <div class="row">
        <div class="col-md-4 mb-3"><%= form.label :mouvement, "Type" %> <%= form.select :mouvement, Transaction::ALLOWED_MVT.values, { prompt: 'Sélectionner...' }, class: "form-select" %></div>
        <div class="col-md-4 mb-3"><%= form.label :source_transaction, "Origine" %> <%= form.select :source_transaction, Transaction::ALLOWED_TSN.values, { prompt: 'Sélectionner...' }, class: "form-select" %></div>
        <div class="col-md-4 mb-3"><%= form.label :payment_method, "Paiement" %> <%= form.select :payment_method, Transaction::ALLOWED_PYT.values, { prompt: 'Sélectionner...' }, class: "form-select" %></div>
      </div>
      <div class="mb-3">
        <%= form.label :user_id, "Lié à l'adhérent (recherche)" %>
        <%# --- Début du composant d'autocomplétion --- %>
        <div data-controller="autocomplete" class="position-relative">
          <%# Champ de texte visible pour la recherche %>
          <input type="text" class="form-control" data-autocomplete-target="input" data-action="input->autocomplete#search" placeholder="Taper un nom..." autocomplete="off">
          
          <%# Champ caché qui contiendra l'ID de l'utilisateur et sera envoyé avec le formulaire %>
          <%= form.hidden_field :user_id, data: { autocomplete_target: "hidden" } %>

          <%# Le Turbo Frame qui recevra et affichera les résultats de la recherche %>
          <turbo-frame id="search_results" class="position-absolute w-100 d-none" data-autocomplete-target="results" style="z-index: 1000;"></turbo-frame>
        </div>
      </div>

      <div class="form-check form-switch mb-3"><%= form.check_box :is_checked, class: "form-check-input" %> <%= form.label :is_checked, "Rapproché en banque", class: "form-check-label" %></div>

      <div class="form-actions mt-4 border-top pt-3">
        <%= form.submit "Enregistrer la transaction", class: "btn btn-success" %>
        <%= link_to 'Annuler', transactions_path, class: 'btn btn-outline-primary ms-2' %>
      </div>

    <% end %>
  </div>
</div>
